@model List<VOCENuOrderApp.Models.NUORDER.OrderStatusSyncLog>
@{
    ViewBag.Title = "Order Status Sync Logs";
    var currentPage = (int)ViewBag.CurrentPage;
    var totalPages = (int)ViewBag.TotalPages;
    int maxPagesToShow = 15;
    int startPage = Math.Max(1, currentPage - (maxPagesToShow / 2));
    int endPage = Math.Min(totalPages, startPage + maxPagesToShow - 1);
    if (endPage - startPage + 1 < maxPagesToShow) { startPage = Math.Max(1, endPage - maxPagesToShow + 1); }
}

<h1 class="page-heading">Order Status Sync Logs</h1>
<p class="page-subheading">Track sales order status transitions pushed between NuOrder and Xoro.</p>

<div class="card log-card mb-4">
    <form method="get" class="filter-bar">
        <label>
            Order Number
            <input name="orderNumber" value="@ViewBag.OrderNumber" class="form-control" placeholder="Order #" />
        </label>
        <label>
            Target Status
            <input name="targetStatus" value="@ViewBag.TargetStatus" class="form-control" placeholder="Status" />
        </label>
        <label>
            Endpoint
            <input name="endpoint" value="@ViewBag.Endpoint" class="form-control" placeholder="path or body" />
        </label>
        <label>
            Success
            <select name="success" class="form-select">
                <option value="">All</option>
                <option value="true" selected="@(ViewBag.Success == "true")">Success</option>
                <option value="false" selected="@(ViewBag.Success == "false")">Failed</option>
            </select>
        </label>
        <label>
            From
            <input type="date" name="fromDate" value="@ViewBag.FromDate" class="form-control" />
        </label>
        <label>
            To
            <input type="date" name="toDate" value="@ViewBag.ToDate" class="form-control" />
        </label>
        <button type="submit" class="btn btn-primary btn-sm">Filter</button>
        <a class="btn btn-outline-secondary btn-sm" href="@Url.Action("ExportCsv", new { orderNumber = ViewBag.OrderNumber, endpoint = ViewBag.Endpoint, success = ViewBag.Success, targetStatus = ViewBag.TargetStatus, fromDate = ViewBag.FromDate, toDate = ViewBag.ToDate })">Export CSV</a>
    </form>

    <div class="table-responsive">
        <table class="table table-log table-hover">
            <thead>
                <tr>
                    <th>Timestamp</th>
                    <th>Order #</th>
                    <th>Internal Id</th>
                    <th>Prev Status</th>
                    <th>Target</th>
                    <th>Success</th>
                    <th>Endpoint</th>
                    <th>Client</th>
                    <th>Error</th>
                    <th>Request URL</th>
                    <th>Request JSON</th>
                    <th>Resp. Code</th>
                    <th>Resp. Body</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var log in Model)
                {
                    <tr>
                        <td>@log.Timestamp.ToString("yyyy-MM-dd HH:mm:ss")</td>
                        <td>@log.OrderNumber</td>
                        <td>@log.NuOrderInternalId</td>
                        <td>@log.PreviousStatus</td>
                        <td>@log.TargetStatus</td>
                        <td>
                            <span class="badge @(log.Success ? "bg-success" : "bg-danger")">@(log.Success ? "Yes" : "No")</span>
                        </td>
                        <td>@log.EndpointUsed</td>
                        <td>@log.Client</td>
                        <td>@(string.IsNullOrWhiteSpace(log.ErrorMessage) ? "" : log.ErrorMessage)</td>
                        <td class="text-break" style="max-width: 200px;">@log.RequestUrl</td>
                        <td class="text-break" style="max-width: 200px;">@log.RequestJson</td>
                        <td>@log.ResponseStatusCode</td>
                        <td class="text-break" style="max-width: 200px;">@log.ResponseBody</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<nav aria-label="Page navigation">
    <ul class="pagination">
        @if (currentPage > 1)
        {
            <li class="page-item">
                <a class="page-link" href="@Url.Action("Index", new { orderNumber=ViewBag.OrderNumber, endpoint=ViewBag.Endpoint, success=ViewBag.Success, targetStatus=ViewBag.TargetStatus, fromDate=ViewBag.FromDate, toDate=ViewBag.ToDate, page=currentPage-1 })">Previous</a>
            </li>
        }
        @for (int i = startPage; i <= endPage; i++)
        {
            <li class="page-item @(i == currentPage ? "active" : "")">
                <a class="page-link" href="@Url.Action("Index", new { orderNumber=ViewBag.OrderNumber, endpoint=ViewBag.Endpoint, success=ViewBag.Success, targetStatus=ViewBag.TargetStatus, fromDate=ViewBag.FromDate, toDate=ViewBag.ToDate, page=i })">@i</a>
            </li>
        }
        @if (currentPage < totalPages)
        {
            <li class="page-item">
                <a class="page-link" href="@Url.Action("Index", new { orderNumber=ViewBag.OrderNumber, endpoint=ViewBag.Endpoint, success=ViewBag.Success, targetStatus=ViewBag.TargetStatus, fromDate=ViewBag.FromDate, toDate=ViewBag.ToDate, page=currentPage+1 })">Next</a>
            </li>
        }
    </ul>
</nav>
